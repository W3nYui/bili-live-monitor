<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Bilibili Live Monitor</title>
    
    <!-- 核心库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 全局字体与动态背景 */
        body { 
            font-family: 'Inter', 'Noto Sans SC', 'Microsoft YaHei', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1e293b; 
            overflow: hidden;
            /* 移动端防回弹 */
            overscroll-behavior: none;
        }

        /* 极光背景动画 */
        .aurora-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(at 0% 0%, rgba(199, 210, 254, 0.5) 0, transparent 50%), 
                radial-gradient(at 50% 100%, rgba(221, 214, 254, 0.5) 0, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(186, 230, 253, 0.5) 0, transparent 50%);
            z-index: -1;
            animation: aurora 20s ease infinite alternate;
        }

        @keyframes aurora {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        /* 磨砂玻璃类 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* 滚动条美化 */
        .scrollbar-custom::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-custom::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-custom::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 10px; }
        
        /* 隐藏横向滚动条但保留功能 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 动画 */
        .msg-enter { animation: slideIn 0.2s cubic-bezier(0.2, 0, 0.2, 1) forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .sc-enter { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 输入框去箭头 */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* 徽章 */
        .badge-guard-3 { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; }
        .badge-guard-2 { background: linear-gradient(135deg, #e879f9 0%, #d946ef 100%); color: white; }
        .badge-guard-1 { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); color: white; }

        /* 移动端 Tab 激活态 */
        .mobile-tab-active { color: #23ade5; background-color: rgba(35, 173, 229, 0.1); }
        .mobile-tab-inactive { color: #64748b; }
        
        /* 图片加载占位 */
        .img-loading { background-color: #e2e8f0; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .7; } }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>
    <!-- 使用 h-dvh 兼容移动端浏览器地址栏 -->
    <div id="root" class="h-screen h-[100dvh] w-screen flex flex-col overflow-hidden relative z-10"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, memo } = React;

        // ==========================================
        // 工具：协议与解包
        // ==========================================
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        const OP = { HEARTBEAT: 2, HEARTBEAT_REPLY: 3, MESSAGE: 5, AUTH: 7, CONNECT_SUCCESS: 8 };
        const CONFIG_KEY = 'bili_monitor_config_v2'; // 更新Key版本

        const getSafeUserColor = (uid) => {
            const hue = uid % 360;
            return `hsl(${hue}, 70%, 35%)`;
        };

        const getAvatarUrl = (uid) => {
            return `https://tenapi.cn/v2/biliavatar?uid=${uid}`;
        };

        // ==========================================
        // 组件
        // ==========================================
        
        // 可拖动悬浮按钮组件
        const DraggableFab = ({ onClick, icon }) => {
            const [pos, setPos] = useState({ x: window.innerWidth - 60, y: window.innerHeight - 120 });
            const isDraggingRef = useRef(false);
            const offsetRef = useRef({ x: 0, y: 0 });
            const startPosRef = useRef({ x: 0, y: 0 });

            const handleStart = (clientX, clientY) => {
                isDraggingRef.current = false;
                startPosRef.current = { x: clientX, y: clientY };
                offsetRef.current = {
                    x: clientX - pos.x,
                    y: clientY - pos.y
                };
            };

            const handleMove = (clientX, clientY) => {
                // 如果移动距离超过 5px，则视为拖动
                if (Math.abs(clientX - startPosRef.current.x) > 5 || Math.abs(clientY - startPosRef.current.y) > 5) {
                    isDraggingRef.current = true;
                }
                
                let newX = clientX - offsetRef.current.x;
                let newY = clientY - offsetRef.current.y;

                // 边界限制
                newX = Math.max(10, Math.min(window.innerWidth - 50, newX));
                newY = Math.max(10, Math.min(window.innerHeight - 50, newY));

                setPos({ x: newX, y: newY });
            };

            // Touch Events
            const onTouchStart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);
            const onTouchMove = (e) => {
                e.preventDefault(); // 防止滚动屏幕
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            };
            
            // Mouse Events
            const onMouseDown = (e) => {
                handleStart(e.clientX, e.clientY);
                const moveHandler = (ev) => handleMove(ev.clientX, ev.clientY);
                const upHandler = () => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            };

            const handleClick = (e) => {
                if (!isDraggingRef.current) {
                    onClick();
                }
            };

            return (
                <div 
                    className="fixed z-[100] w-12 h-12 rounded-full bg-slate-800 text-white shadow-2xl flex items-center justify-center cursor-move touch-none active:scale-95 transition-transform border border-slate-600/50"
                    style={{ left: pos.x, top: pos.y }}
                    onTouchStart={onTouchStart}
                    onTouchMove={onTouchMove}
                    onMouseDown={onMouseDown}
                    onClick={handleClick}
                >
                    {icon}
                </div>
            );
        };

        const UserAvatar = memo(({ uid, name, faceUrl, className, onClick }) => {
            const [isError, setIsError] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            
            const src = faceUrl || getAvatarUrl(uid);
            
            if (!uid || isError) {
                const initial = name ? name.substring(0, 1).toUpperCase() : '?';
                return (
                    <div onClick={onClick} className={`relative ${className} group shrink-0 rounded-full flex items-center justify-center text-white font-bold select-none bg-indigo-400 text-[10px] shadow-sm cursor-pointer`}>
                        {initial}
                    </div>
                );
            }

            return (
                <div onClick={onClick} className={`relative ${className} group shrink-0 cursor-pointer`}>
                    <img 
                        src={src} 
                        alt={name}
                        loading="lazy" 
                        className={`w-full h-full rounded-full object-cover border border-white/50 shadow-sm transition-opacity duration-300 ${isLoading ? 'opacity-0' : 'opacity-100'}`}
                        onLoad={() => setIsLoading(false)}
                        onError={() => {
                            setIsError(true);
                            setIsLoading(false);
                        }} 
                    />
                    {isLoading && (
                        <div className="absolute inset-0 rounded-full bg-slate-200 animate-pulse"></div>
                    )}
                </div>
            );
        });

        const Medals = ({ data }) => {
            if (!data || data.length < 2) return null;
            const [level, name] = data;
            const isHigh = level >= 20;
            const bgClass = isHigh ? 'bg-gradient-to-r from-orange-400 to-amber-500' : level >= 10 ? 'bg-gradient-to-r from-blue-400 to-cyan-500' : 'bg-slate-400';
            
            return (
                <div className="inline-flex items-center rounded overflow-hidden text-[10px] h-3.5 leading-none mr-1 align-middle select-none ring-1 ring-black/5">
                    <span className={`${bgClass} text-white px-1 h-full flex items-center font-bold`}>{name}</span>
                    <span className="bg-white text-slate-600 px-0.5 h-full flex items-center font-bold font-mono text-[9px]">{level}</span>
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 fade-in" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-slate-800">获取 Token (防断连)</h3>
                        <button onClick={onClose}><i className="fa-solid fa-xmark text-slate-400"></i></button>
                    </div>
                    <div className="p-4 text-xs space-y-3 text-slate-600">
                        <p>电脑浏览器打开直播间 -> F12 -> Network -> 刷新 -> 搜 <code className="bg-slate-100 p-0.5 rounded">getDanmuInfo</code> -> 查看 Preview 中的 <code className="text-pink-500">token</code>。</p>
                        <p className="text-amber-600 bg-amber-50 p-2 rounded">Token必须与UID匹配，否则连接会失败。</p>
                    </div>
                </div>
            </div>
        );

        const RoomIdHelpModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 fade-in" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                        <h3 className="font-bold text-slate-800">如何获取真实房间号?</h3>
                        <button onClick={onClose}><i className="fa-solid fa-xmark text-slate-400"></i></button>
                    </div>
                    <div className="p-4 text-xs space-y-3 text-slate-600">
                        <p>部分主播使用短号（如 1），但连接服务器需要长ID。</p>
                        <p>如果自动获取失败：网页右键 -> 查看源代码 -> 搜索 <code className="text-pink-600 font-mono">"roomId":</code> 后的数字。</p>
                    </div>
                </div>
            </div>
        );

        // ==========================================
        // 主应用
        // ==========================================
        function App() {
            // State
            const [config, setConfig] = useState(() => {
                const defaultState = { 
                    mode: 'web', roomId: '', realRoomId: '', token: '', uid: '', 
                    wsUrl: 'wss://broadcastlv.chat.bilibili.com/sub', 
                    maxMessages: 200, giftTimeout: 0,
                    singleColumn: false // 新增：是否开启单列模式
                };
                try {
                    const saved = localStorage.getItem(CONFIG_KEY);
                    if (saved) return { ...defaultState, ...JSON.parse(saved) };
                } catch (e) {}
                return defaultState;
            });

            // 保存配置到本地存储
            useEffect(() => {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            }, [config]);

            const configRef = useRef(config);
            useEffect(() => { configRef.current = config; }, [config]);

            const [status, setStatus] = useState('idle'); 
            const [popularity, setPopularity] = useState(0);
            const [roomInfo, setRoomInfo] = useState(null);
            const [danmus, setDanmus] = useState([]);
            const [interactions, setInteractions] = useState([]); 
            const [superChats, setSuperChats] = useState([]); 
            
            // 新增：单列模式下选中的SC
            const [activeSC, setActiveSC] = useState(null);

            // UI State
            const [showSettings, setShowSettings] = useState(true);
            const [showHelp, setShowHelp] = useState(false);
            const [showRoomHelp, setShowRoomHelp] = useState(false);
            const [fontSize, setFontSize] = useState(15);
            const [autoScroll, setAutoScroll] = useState(true);
            const [showScrollBtn, setShowScrollBtn] = useState(false);
            const [mobileTab, setMobileTab] = useState('chat');

            const wsRef = useRef(null);
            const hbRef = useRef(null);
            const danmuScrollRef = useRef(null);
            const giftScrollRef = useRef(null);
            const isConnectingRef = useRef(false);

            // Scroll Logic
            useEffect(() => {
                if (autoScroll && danmuScrollRef.current) danmuScrollRef.current.scrollTop = danmuScrollRef.current.scrollHeight;
            }, [danmus, autoScroll]);

            const handleScroll = (e) => {
                const { scrollTop, scrollHeight, clientHeight } = e.target;
                const isAtBottom = scrollHeight - scrollTop - clientHeight < 50;
                if (isAtBottom) {
                    if (!autoScroll) setAutoScroll(true);
                    if (showScrollBtn) setShowScrollBtn(false);
                } else {
                    if (autoScroll) setAutoScroll(false);
                    if (!showScrollBtn) setShowScrollBtn(true);
                }
            };

            const scrollToBottom = () => {
                if (danmuScrollRef.current) {
                    danmuScrollRef.current.scrollTo({ top: danmuScrollRef.current.scrollHeight, behavior: 'smooth' });
                    setAutoScroll(true);
                    setShowScrollBtn(false);
                }
            };

            useEffect(() => {
                if (giftScrollRef.current && (mobileTab === 'interactions' || config.singleColumn)) {
                    giftScrollRef.current.scrollTop = giftScrollRef.current.scrollHeight;
                }
            }, [interactions, mobileTab, config.singleColumn]);

            // Gift Cleanup
            useEffect(() => {
                const interval = setInterval(() => {
                    const timeout = config.giftTimeout;
                    if (timeout > 0) {
                        const now = Date.now();
                        setInteractions(prev => {
                            const next = prev.filter(item => item.lastUpdated ? (now - item.lastUpdated) < (timeout * 1000) : true);
                            return next.length !== prev.length ? next : prev;
                        });
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [config.giftTimeout]);

            // Connection Logic
            const fetchRoomInfo = async (shortId) => {
                try {
                    let url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${shortId}`)}`;
                    const res = await fetch(url, { signal: AbortSignal.timeout(3000) }).then(r => r.json());
                    const data = JSON.parse(res.contents);
                    if (data.code === 0) return data.data.room_id;
                } catch (e) { console.log("Proxy fetch failed"); }
                return parseInt(shortId);
            };

            const fetchLiveDetails = async (realId) => {
                try {
                    const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByRoom?room_id=${realId}`)}`;
                    const res = await fetch(url).then(r => r.json());
                    const json = JSON.parse(res.contents);
                    if (json.code === 0 && json.data) {
                        setRoomInfo({
                            title: json.data.room_info?.title || '',
                            uname: json.data.anchor_info?.base_info?.uname || ''
                        });
                    }
                } catch (e) {}
            }

            const connect = async () => {
                if (isConnectingRef.current || status === 'connected') return;
                if (!config.roomId) { alert("请输入房间号"); return; }

                isConnectingRef.current = true;
                setStatus('connecting');
                disconnect(false);
                setDanmus([]); setInteractions([]); setRoomInfo(null);
                
                try {
                    let targetRoom = await fetchRoomInfo(config.roomId);
                    setConfig(p => ({...p, realRoomId: targetRoom}));
                    fetchLiveDetails(targetRoom);

                    const auth = { 
                        uid: parseInt(config.uid) || 0, roomid: parseInt(targetRoom), 
                        protover: 2, platform: 'web', type: 2, ...(config.token ? {key: config.token} : {}) 
                    };

                    const ws = new WebSocket(config.wsUrl);
                    ws.binaryType = 'arraybuffer';
                    wsRef.current = ws;

                    ws.onopen = () => {
                        send(ws, auth, OP.AUTH);
                        hbRef.current = setInterval(() => ws.readyState === 1 && send(ws, {}, OP.HEARTBEAT), 30000);
                        setTimeout(() => isConnectingRef.current = false, 500);
                    };
                    ws.onmessage = e => handlePacket(e.data);
                    ws.onclose = () => { setStatus('idle'); clearInterval(hbRef.current); isConnectingRef.current = false; };
                    ws.onerror = () => { setStatus('error'); isConnectingRef.current = false; };
                } catch (e) { setStatus('error'); alert("连接失败，请检查网络或房间号"); isConnectingRef.current = false; }
            };

            const disconnect = (updateStatus = true) => {
                wsRef.current?.close(); clearInterval(hbRef.current);
                if(updateStatus) { setStatus('idle'); setRoomInfo(null); }
            };

            const send = (ws, data, op) => {
                const body = textEncoder.encode(JSON.stringify(data));
                const header = new ArrayBuffer(16);
                const v = new DataView(header);
                v.setUint32(0, 16 + body.byteLength); v.setUint16(4, 16); v.setUint16(6, 1); v.setUint32(8, op); v.setUint32(12, 1);
                const pkg = new Uint8Array(16 + body.byteLength);
                pkg.set(new Uint8Array(header), 0); pkg.set(body, 16);
                ws.send(pkg);
            };

            const handlePacket = async (buf) => {
                const view = new DataView(buf);
                let offset = 0;
                while (offset < buf.byteLength) {
                    if (offset + 16 > buf.byteLength) break;
                    const len = view.getUint32(offset), head = view.getUint16(offset+4), ver = view.getUint16(offset+6), op = view.getUint32(offset+8);
                    const body = buf.slice(offset + head, offset + len);
                    if (ver === 2) { try { await handlePacket(pako.inflate(new Uint8Array(body)).buffer); } catch {} } 
                    else if (op === OP.HEARTBEAT_REPLY) { setPopularity(new DataView(body).getUint32(0)); } 
                    else if (op === OP.CONNECT_SUCCESS) { setStatus('connected'); setShowSettings(false); } 
                    else if (op === OP.MESSAGE) { try { handleMsg(JSON.parse(textDecoder.decode(body))); } catch {} }
                    offset += len;
                }
            };

            const handleMsg = (json) => {
                const cmd = json.cmd;
                const nowTimestamp = Date.now();
                const timeStr = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute:'2-digit' });
                const id = Math.random().toString(36).substr(2);

                if (cmd.startsWith('DANMU_MSG')) {
                    const info = json.info;
                    const m = {
                        type: 'DANMU', id, time: timeStr,
                        uid: info[2][0], user: info[2][1], content: info[1],
                        nameColor: getSafeUserColor(info[2][0]), 
                        isAdmin: info[2][2] === 1, guard: info[7],
                        medal: info[3].length > 0 ? info[3] : null,
                        face: null
                    };
                    setDanmus(prev => [...prev.slice(-(configRef.current.maxMessages || 200) + 1), m]);
                } else if (cmd === 'SEND_GIFT') {
                    const d = json.data;
                    const newGift = { 
                        type: 'GIFT', id, time: timeStr, uid: d.uid, user: d.uname, 
                        giftName: d.giftName, num: d.num, count: d.num, action: d.action,
                        lastUpdated: nowTimestamp,
                        face: d.face 
                    };
                    setInteractions(prev => {
                        const last = prev[prev.length - 1];
                        if (last && last.type === 'GIFT' && last.uid === newGift.uid && last.giftName === newGift.giftName && last.action === newGift.action) {
                            const newList = [...prev];
                            newList[prev.length - 1] = { ...last, count: last.count + newGift.num, time: timeStr, lastUpdated: nowTimestamp };
                            return newList;
                        }
                        return [...prev.slice(-99), newGift];
                    });
                } else if (cmd === 'GUARD_BUY') {
                    const d = json.data;
                    setInteractions(prev => [...prev.slice(-99), { 
                        type: 'GUARD', id, time: timeStr, uid: d.uid, user: d.username, 
                        level: {1:'总督', 2:'提督', 3:'舰长'}[d.guard_level], lastUpdated: nowTimestamp,
                        face: null 
                    }]);
                } else if (cmd === 'SUPER_CHAT_MESSAGE') {
                    const d = json.data;
                    setSuperChats(prev => [{ 
                        type: 'SC', id, time: timeStr, uid: d.uid, user: d.user_info.uname, 
                        price: d.price, content: d.message, user_face: d.user_info.face,
                        bg_color: d.background_bottom_color, price_color: d.background_price_color
                    }, ...prev]);
                }
            };

            const removeSC = (targetId) => {
                setSuperChats(prev => prev.filter(sc => sc.id !== targetId));
                if (activeSC && activeSC.id === targetId) setActiveSC(null);
            };

            // ==========================================
            // 单列模式渲染逻辑 (New)
            // ==========================================
            const renderSingleColumnMode = () => (
                <div className="flex flex-col h-full w-full relative">
                    {/* 上半部分：SC 和 礼物 (35%) */}
                    <div className="h-[35%] min-h-[160px] flex flex-col border-b border-slate-200/50 relative">
                        {/* SC 头像栏 (Compact Mode) */}
                        {superChats.length > 0 && (
                            <div className="flex items-center gap-3 p-2 overflow-x-auto scrollbar-hide bg-white/40 shrink-0 h-[60px]">
                                <span className="text-[10px] font-bold text-amber-500 shrink-0 writing-vertical-lr transform rotate-180">SC</span>
                                {superChats.map(sc => (
                                    <div key={sc.id} className="relative group shrink-0" onClick={() => setActiveSC(sc)}>
                                        <div className={`p-0.5 rounded-full ${activeSC?.id === sc.id ? 'ring-2 ring-amber-400 scale-110' : 'ring-1 ring-amber-200/50'} transition-all`}>
                                            <UserAvatar uid={sc.uid} name={sc.user} faceUrl={sc.user_face} className="w-10 h-10" />
                                        </div>
                                        <span className="absolute -bottom-1 right-0 text-[8px] bg-red-500 text-white px-1 rounded-full scale-90">¥{sc.price}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 弹出的 SC 详情卡片 (Overlay) */}
                        {activeSC && (
                            <div className="absolute top-16 left-2 right-2 z-50 sc-enter">
                                <div className="p-3 rounded-xl shadow-xl text-xs text-white relative backdrop-blur-md" style={{background: activeSC.bg_color || '#c00'}}>
                                    <div className="flex gap-3">
                                        <UserAvatar uid={activeSC.uid} name={activeSC.user} faceUrl={activeSC.user_face} className="w-10 h-10 rounded-full border border-white/50" />
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between font-bold mb-1 opacity-90 border-b border-white/20 pb-1">
                                                <span>{activeSC.user}</span>
                                                <span>¥{activeSC.price}</span>
                                            </div>
                                            <div className="leading-relaxed">{activeSC.content}</div>
                                        </div>
                                    </div>
                                    <div className="absolute top-0 right-0 p-2 flex gap-2">
                                        <button onClick={(e) => { e.stopPropagation(); removeSC(activeSC.id); }} className="text-white/60 hover:text-white"><i className="fa-solid fa-check"></i></button>
                                        <button onClick={(e) => { e.stopPropagation(); setActiveSC(null); }} className="text-white/60 hover:text-white"><i className="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 礼物列表 */}
                        <div className="flex-1 overflow-hidden relative flex flex-col">
                            <div ref={giftScrollRef} className="flex-1 overflow-y-auto p-2 space-y-1.5 scrollbar-custom bg-white/20">
                                {interactions.length === 0 && <div className="text-center text-slate-400 mt-4 text-[10px]">等待互动...</div>}
                                {interactions.map((m) => (
                                    <div key={m.id} className="text-xs flex items-center justify-between bg-white/40 p-1.5 rounded-lg shadow-sm border border-white/30 fade-in">
                                        <div className="flex items-center gap-1 min-w-0">
                                            <span className="font-bold text-[#fb7299] truncate max-w-[80px]">{m.user}</span>
                                            <span className="text-slate-500 text-[10px]">{m.type === 'GUARD' ? '开通' : m.action}</span>
                                            <span className="font-bold text-slate-700 truncate max-w-[80px]">{m.type === 'GUARD' ? m.level : m.giftName}</span>
                                        </div>
                                        {m.type === 'GIFT' && <span className="bg-[#fb7299] text-white px-1 rounded font-mono font-bold text-[9px]">x{m.count}</span>}
                                    </div>
                                ))}
                            </div>
                            {interactions.length > 0 && (
                                <button onClick={()=>setInteractions([])} className="absolute bottom-1 right-2 text-slate-300 hover:text-red-400 text-xs p-1 bg-white/50 rounded backdrop-blur">
                                    <i className="fa-solid fa-trash-can"></i>
                                </button>
                            )}
                        </div>
                    </div>

                    {/* 下半部分：弹幕 (Flex-1) */}
                    <div className="flex-1 overflow-hidden relative">
                         <div ref={danmuScrollRef} onScroll={handleScroll} className="h-full overflow-y-auto p-3 space-y-2 scrollbar-custom" style={{ fontSize: `${fontSize}px` }}>
                            {danmus.length === 0 && <div className="h-full flex items-center justify-center text-slate-400/50"><i className="fa-regular fa-comments text-3xl"></i></div>}
                            {danmus.map((m) => (
                                <div key={m.id} className="msg-enter flex gap-2 px-1 py-1 rounded hover:bg-white/30">
                                    <div className="flex-1 min-w-0 leading-snug break-all text-shadow-sm">
                                        {m.guard > 0 && <span className={`mr-1 text-[9px] px-1 rounded text-white inline-block align-middle ${'badge-guard-'+m.guard}`}>{m.guard===3?'舰':m.guard===2?'提':'督'}</span>}
                                        <span className="font-bold text-xs opacity-80 mr-1.5 cursor-pointer hover:underline" style={{color: m.nameColor}} title={m.user}>{m.user}:</span>
                                        <span className="text-slate-800">{m.content}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {showScrollBtn && <button onClick={scrollToBottom} className="absolute bottom-4 right-4 bg-slate-800/80 text-white w-8 h-8 rounded-full shadow-lg flex items-center justify-center animate-bounce z-10 text-xs"><i className="fa-solid fa-arrow-down"></i></button>}
                    </div>
                </div>
            );

            // ==========================================
            // 渲染 Root
            // ==========================================
            // 检测是否需要显示浮动按钮：单列模式 OR 屏幕宽度小于768px
            const showFloatingBtn = config.singleColumn || window.innerWidth < 768;

            return (
                <div className="flex flex-col h-full text-slate-700">
                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    {showRoomHelp && <RoomIdHelpModal onClose={() => setShowRoomHelp(false)} />}
                    
                    {/* 浮动设置按钮 (只在单列模式或小屏幕下显示，且设置面板未打开时) */}
                    {showFloatingBtn && !showSettings && (
                        <DraggableFab onClick={() => setShowSettings(true)} icon={<i className="fa-solid fa-gear text-xl"></i>} />
                    )}

                    {/* Header */}
                    <header className={`glass-panel flex items-center justify-between px-3 shrink-0 z-30 sticky top-0 shadow-sm transition-all ${config.singleColumn ? 'h-10 md:h-12' : 'h-14 md:h-16'}`}>
                        <div className="flex items-center gap-3">
                            <div className="flex items-center gap-2 group cursor-default">
                                <div className={`bg-white rounded-lg shadow-md flex items-center justify-center text-[#23ade5] group-hover:rotate-12 transition-transform ${config.singleColumn ? 'w-6 h-6 text-sm' : 'w-9 h-9 text-xl'}`}>
                                    <i className="fa-brands fa-bilibili"></i>
                                </div>
                                {!config.singleColumn && (
                                    <div className="flex flex-col">
                                        <span className="font-bold text-lg text-slate-800 tracking-tight leading-none">Bili<span className="text-[#fb7299]">Monitor</span></span>
                                        <span className="text-[10px] text-slate-500 font-medium tracking-wider">by_W3nYui</span>
                                    </div>
                                )}
                            </div>
                            
                            <div className={`flex px-2 py-0.5 rounded-full text-[10px] font-bold items-center gap-1.5 border shadow-sm transition-all duration-500 max-w-[40vw] overflow-hidden ${
                                status === 'connected' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 
                                status === 'connecting' ? 'bg-blue-50 text-blue-600 border-blue-200' : 
                                'bg-slate-50 text-slate-500 border-slate-200'
                            }`}>
                                <div className="relative flex h-2 w-2 shrink-0">
                                  {status === 'connected' && <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>}
                                  <span className={`relative inline-flex rounded-full h-2 w-2 ${status==='connected'?'bg-emerald-500':status==='connecting'?'bg-blue-500':'bg-slate-400'}`}></span>
                                </div>
                                <span className="truncate">{status === 'connected' ? (roomInfo?.uname || config.realRoomId) : (status === 'connecting' ? '...' : '断开')}</span>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                             {/* 热度 */}
                            <div className="flex items-center bg-white/50 px-2 py-1 rounded-full border border-white/60 text-slate-700 shadow-sm backdrop-blur-md">
                                <i className="fa-solid fa-fire text-[#fb7299] mr-1.5 text-[10px]"></i>
                                <span className="font-mono font-bold text-xs">{popularity.toLocaleString()}</span>
                            </div>

                            {/* 在非单列模式下保留Header中的设置按钮，作为备用或桌面端使用 */}
                            {!config.singleColumn && (
                                <button onClick={() => setShowSettings(!showSettings)} className={`w-8 h-8 flex items-center justify-center rounded-full transition-all shadow-sm border ${showSettings ? 'bg-slate-800 text-white border-slate-800 rotate-90' : 'bg-white text-slate-600 border-white/60'}`}>
                                    <i className="fa-solid fa-gear text-sm"></i>
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* Settings Sidebar */}
                        <div className={`absolute inset-y-0 left-0 w-full md:w-80 z-50 transition-transform duration-300 ${showSettings ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="h-full glass-panel md:rounded-r-2xl shadow-2xl flex flex-col overflow-hidden bg-white/95">
                                <div className="p-5 space-y-5 h-full overflow-y-auto">
                                    <div className="flex justify-between items-center border-b pb-3">
                                        <h3 className="font-bold text-slate-800">监控设置</h3>
                                        <button onClick={() => setShowSettings(false)} className="bg-slate-100 w-7 h-7 rounded-full text-slate-500 text-sm"><i className="fa-solid fa-xmark"></i></button>
                                    </div>
                                    <div className="space-y-4">
                                        {/* 模式切换 (New) */}
                                        <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${config.singleColumn ? 'bg-indigo-100 text-indigo-500' : 'bg-slate-200 text-slate-500'}`}>
                                                        <i className={`fa-solid ${config.singleColumn ? 'fa-table-columns' : 'fa-table-cells'}`}></i>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs font-bold text-slate-700">单列模式</div>
                                                        <div className="text-[10px] text-slate-400">适合侧边栏/手机/OBS</div>
                                                    </div>
                                                </div>
                                                <label className="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" className="sr-only peer" checked={config.singleColumn} onChange={e => setConfig({...config, singleColumn: e.target.checked})} />
                                                    <div className="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500"></div>
                                                </label>
                                            </div>
                                        </div>

                                        <div className="group">
                                            <div className="flex justify-between items-center mb-1.5">
                                                <label className="text-xs font-bold text-slate-500 block">ROOM ID</label>
                                                <button onClick={() => setShowRoomHelp(true)} className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full">帮助</button>
                                            </div>
                                            <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-800 text-sm font-bold font-mono outline-none focus:ring-2 ring-blue-500/20" 
                                                value={config.roomId} onChange={e=>setConfig({...config, roomId:e.target.value})} placeholder="直播间号" />
                                        </div>

                                        <div className="group">
                                            <label className="text-xs font-bold text-slate-500 mb-1.5 block">MY UID</label>
                                            <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-800 text-sm font-mono outline-none focus:ring-2 ring-blue-500/20" 
                                                value={config.uid} onChange={e=>setConfig({...config, uid:e.target.value})} placeholder="输入您的UID" />
                                        </div>

                                        <div className="group">
                                            <div className="flex justify-between mb-1.5"><label className="text-xs font-bold text-slate-500">TOKEN</label><button onClick={()=>setShowHelp(true)} className="text-blue-500 text-[10px]">获取教程</button></div>
                                            <input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-600 text-xs font-mono outline-none focus:ring-2 ring-blue-500/20" 
                                                value={config.token} onChange={e=>setConfig({...config, token:e.target.value})} placeholder="粘贴 Token..." />
                                        </div>

                                        <div className="grid grid-cols-2 gap-3 pt-2 border-t border-slate-200/50">
                                            <div className="group">
                                                <label className="text-[10px] font-bold text-slate-500 mb-1 block">MAX HISTORY</label>
                                                <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-slate-800 text-xs outline-none focus:border-blue-400 font-mono" 
                                                    value={config.maxMessages} 
                                                    onChange={e=>setConfig({...config, maxMessages: Math.max(10, parseInt(e.target.value) || 200)})} />
                                            </div>
                                            <div className="group">
                                                <label className="text-[10px] font-bold text-slate-500 mb-1 block">GIFT TIMEOUT (S)</label>
                                                <input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-slate-800 text-xs outline-none focus:border-blue-400 font-mono" 
                                                    value={config.giftTimeout} 
                                                    onChange={e=>setConfig({...config, giftTimeout: Math.max(0, parseInt(e.target.value) || 0)})} 
                                                    placeholder="0" />
                                            </div>
                                        </div>

                                        <div className="pt-2 border-t">
                                            <label className="text-xs font-bold text-slate-500 block mb-2">字体大小: {fontSize}px</label>
                                            <input type="range" min="12" max="28" step="1" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none accent-blue-500" />
                                        </div>
                                    </div>
                                    <div className="pt-2 mt-auto">
                                        {status === 'connected' ? 
                                            <button onClick={() => disconnect(true)} className="w-full bg-red-50 text-red-500 py-2.5 rounded-xl font-bold border border-red-100 text-sm">断开连接</button> :
                                            <button onClick={connect} disabled={status === 'connecting'} className="w-full bg-[#23ade5] text-white py-2.5 rounded-xl font-bold shadow-lg shadow-blue-200 disabled:opacity-50 text-sm">
                                                {status === 'connecting' ? '连接中...' : '开始监听'}
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div className="absolute inset-0 bg-black/20 z-[-1] md:hidden" onClick={() => setShowSettings(false)}></div>
                        </div>

                        {/* 视图渲染逻辑分支 */}
                        {config.singleColumn ? (
                            /* 分支 A: 单列模式 (Single Column Mode) */
                            <div className="flex-1 glass-panel md:rounded-2xl md:my-4 md:mx-4 overflow-hidden shadow-lg">
                                {renderSingleColumnMode()}
                            </div>
                        ) : (
                            /* 分支 B: 标准双栏/Tab模式 (Standard Mode) */
                            <>
                                {/* Chat Area */}
                                <div 
                                    className={`flex-1 flex flex-col min-w-0 relative z-10 md:my-4 md:ml-4 md:rounded-2xl glass-panel md:shadow-lg overflow-hidden transition-all duration-300
                                    ${mobileTab === 'chat' ? 'opacity-100 z-20' : 'opacity-0 md:opacity-100 absolute md:relative inset-0 z-0 pointer-events-none md:pointer-events-auto'}`}
                                >
                                    <div ref={danmuScrollRef} onScroll={handleScroll} className="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-custom" style={{ fontSize: `${fontSize}px` }}>
                                        {danmus.length === 0 && <div className="h-full flex items-center justify-center text-slate-400/50"><i className="fa-regular fa-comments text-4xl"></i></div>}
                                        {danmus.map((m) => (
                                            <div key={m.id} className="msg-enter flex gap-2.5 px-2 py-1.5 rounded-lg hover:bg-white/40">
                                                <UserAvatar uid={m.uid} name={m.user} faceUrl={m.face} className="w-8 h-8 text-xs mt-0.5" />
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-1.5 mb-0.5 flex-wrap">
                                                        {m.medal && <Medals data={m.medal} />}
                                                        {m.guard > 0 && <span className={`text-[9px] px-1 rounded text-white ${'badge-guard-'+m.guard}`}>{m.guard===3?'舰':m.guard===2?'提':'督'}</span>}
                                                        <span className="font-bold text-xs opacity-90 truncate" style={{color: m.nameColor}}>{m.user}</span>
                                                    </div>
                                                    <div className="leading-snug text-slate-800 break-all">{m.content}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    {showScrollBtn && <button onClick={scrollToBottom} className="absolute bottom-6 right-6 bg-slate-800 text-white w-10 h-10 rounded-full shadow-xl flex items-center justify-center animate-bounce"><i className="fa-solid fa-arrow-down"></i></button>}
                                </div>

                                {/* Interactions Area */}
                                <div 
                                    className={`md:w-80 flex flex-col shrink-0 z-10 md:mr-4 md:my-4 space-y-3 
                                    ${mobileTab === 'interactions' ? 'absolute inset-0 bg-white/90 z-20 p-4 md:static md:bg-transparent md:p-0' : 'hidden md:flex'}`}
                                >
                                    {/* Super Chats (Desktop Standard) */}
                                    {superChats.length > 0 && (
                                        <div className="glass-panel rounded-xl overflow-hidden shadow-md flex flex-col max-h-[40vh] shrink-0 border-amber-200/50">
                                            <div className="h-8 bg-gradient-to-r from-amber-50 to-white flex items-center justify-between px-3 border-b border-amber-100">
                                                <span className="text-xs font-bold text-amber-500">SUPER CHATS ({superChats.length})</span>
                                            </div>
                                            <div className="overflow-y-auto p-2 space-y-2 scrollbar-custom bg-white/30">
                                                {superChats.map(sc => (
                                                    <div key={sc.id} onClick={() => removeSC(sc.id)} className="sc-enter p-2 rounded-lg shadow-sm text-xs text-white relative cursor-pointer" style={{background: sc.bg_color || '#c00'}}>
                                                        <div className="flex gap-2">
                                                            <UserAvatar uid={sc.uid} name={sc.user} faceUrl={sc.user_face} className="w-8 h-8 rounded-full border border-white/50" />
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex justify-between font-bold mb-1 opacity-90"><span>{sc.user}</span><span>¥{sc.price}</span></div>
                                                                <div>{sc.content}</div>
                                                            </div>
                                                        </div>
                                                        <i className="fa-solid fa-xmark absolute top-1 right-1 opacity-50 p-1"></i>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Gifts & Logs */}
                                    <div className="glass-panel rounded-xl overflow-hidden shadow-md flex-1 flex flex-col min-h-0">
                                        <div className="h-9 bg-white/40 border-b flex items-center px-3 justify-between">
                                            <span className="text-xs font-bold text-slate-500">互动记录</span>
                                            <button onClick={()=>setInteractions([])} className="text-slate-400 hover:text-red-400"><i className="fa-solid fa-trash-can"></i></button>
                                        </div>
                                        <div ref={giftScrollRef} className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-custom bg-white/20">
                                            {interactions.length === 0 && <div className="text-center text-slate-400 mt-8 text-xs">暂无礼物</div>}
                                            {interactions.map((m) => (
                                                <div key={m.id} className="text-xs flex items-center justify-between bg-white/60 p-2 rounded-lg border border-white/50 shadow-sm">
                                                    <div className="flex items-center gap-2 min-w-0">
                                                        <div className="truncate pr-2">
                                                            <span className="font-bold text-[#fb7299]">{m.user}</span>
                                                            <span className="text-slate-500 mx-1">{m.type === 'GUARD' ? '开通了' : m.action}</span>
                                                            <span className="font-bold text-slate-700">{m.type === 'GUARD' ? m.level : m.giftName}</span>
                                                        </div>
                                                    </div>
                                                    {m.type === 'GIFT' && <span className="bg-[#fb7299] text-white px-1.5 rounded font-mono font-bold text-[10px]">x{m.count}</span>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {/* Mobile Bottom Navigation Tab (Only show in Standard Mode) */}
                    {!config.singleColumn && (
                        <div className="md:hidden shrink-0 h-14 bg-white/80 backdrop-blur-md border-t border-slate-200 flex items-center justify-around z-50 pb-safe">
                            <button 
                                onClick={() => setMobileTab('chat')} 
                                className={`flex flex-col items-center gap-0.5 px-6 py-1 rounded-xl transition-colors ${mobileTab === 'chat' ? 'text-[#23ade5]' : 'text-slate-400'}`}
                            >
                                <i className="fa-solid fa-comments text-lg"></i>
                                <span className="text-[10px] font-bold">弹幕</span>
                            </button>
                            <button 
                                onClick={() => setMobileTab('interactions')} 
                                className={`flex flex-col items-center gap-0.5 px-6 py-1 rounded-xl transition-colors ${mobileTab === 'interactions' ? 'text-[#fb7299]' : 'text-slate-400'}`}
                            >
                                <i className="fa-solid fa-gift text-lg"></i>
                                <span className="text-[10px] font-bold">礼物/SC</span>
                                {(interactions.length > 0 || superChats.length > 0) && <span className="absolute top-3 ml-4 w-2 h-2 bg-red-500 rounded-full border border-white"></span>}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>